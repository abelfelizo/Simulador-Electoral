<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Inteligencia Electoral 2028 · Simulador FP</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=222"/>
</head>
<body>
  
<select id="yearBase" style="display:none"><option value="2024">2024</option><option value="2020">2020</option></select>
<select id="scenario" style="display:none">
<option value="moderado">Moderado</option>
<option value="optimista">Optimista</option>
<option value="adverso">Adverso</option>
<option value="custom">Personalizado</option>
</select>

<div id="appLoader" class="appLoader"><div class="appLoader__box">Cargando datos…</div></div>

  <!-- Header IE2028 -->
  <header class="ieHeader">
    <div class="ieHeader__left">
      <div class="ieBrand">
        <div class="ieBrand__mark">FP</div>
        <div class="ieBrand__txt">
          <div class="ieBrand__name">FUERZA DEL PUEBLO</div>
          <div class="ieBrand__sub">Simulador Electoral 2028</div>
        </div>
      </div>
    </div>

    <div class="ieHeader__center">
      <div class="ieTitle">INTELIGENCIA ELECTORAL 2028</div>
      <div class="ieSubtitle">Comisión de Análisis, Formación y Tecnología · Plan Maestro</div>
    </div>

    <div class="ieHeader__right">
      <div class="ieBadge">EJE<br><b>B</b></div>
    </div>
  </header>

  <!-- Top stats -->
  <section class="ieStats">
    <div class="stat">
      <div class="stat__k">FP Nacional 2024</div>
      <div class="stat__v" id="kpiFP">—</div>
      <div class="stat__s" id="kpiFPsub">—</div>
    </div>
    <div class="stat">
      <div class="stat__k">PRM Nacional 2024</div>
      <div class="stat__v" id="kpiPRM">—</div>
      <div class="stat__s" id="kpiPRMsub">—</div>
    </div>
    <div class="stat">
      <div class="stat__k">PLD Nacional 2024</div>
      <div class="stat__v" id="kpiPLD">—</div>
      <div class="stat__s" id="kpiPLDsub">—</div>
    </div>
    <div class="stat">
      <div class="stat__k">Municipios analizados</div>
      <div class="stat__v" id="kpiMuns">—</div>
      <div class="stat__s">Datos JCE 2020–2024</div>
    </div>
    <div class="stat">
      <div class="stat__k">Votos válidos 2024</div>
      <div class="stat__v" id="kpiValid">—</div>
      <div class="stat__s">Total nacional</div>
    </div>
  </section>

  <!-- IE Tabs -->
  <nav class="ieTabs">
    <button class="ieTab isActive" data-ie="b1">B.1 · Mapa Electoral</button>
    <button class="ieTab" data-ie="b2">B.2 · Clasificador Municipal</button>
    <button class="ieTab" data-ie="b3">B.3 · Abstención y Voto Potencial</button>
    <div class="ieTabs__spacer"></div>

    <!-- Primary simulator navigation -->
    <div class="ieNav">
      <button class="navbtn isActive" data-view="dashboard">Dashboard</button>
      <button class="navbtn" data-view="presidencial">Presidencial</button>
      <button class="navbtn" data-view="senadores">Senadores</button>
      <button class="navbtn" data-view="diputados">Diputados</button>
      <button class="navbtn" data-view="alcaldes">Alcaldes</button>
    </div>

    <button class="btn ghost" id="btnExportScenario" type="button">Exportar escenario</button>
  </nav>

  <main class="ieMain">
    <div id="dataAlerts" class="alertBar" style="display:none"></div>

    <button class="mobileMenuBtn" id="btnMobileMenu" type="button">☰ Menú</button>

    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="panel">
          <div class="panel__title">Configuración</div>

          <label class="field">
            <div class="field__label">Año base</div>
            <select id="year">
              <option value="2024">2024</option>
              <option value="2020">2020</option>
            </select>
          </label>

          <label class="field">
            <div class="field__label">Escenario</div>
            <select id="scenarioSelect">
              <option value="moderado">Moderado</option>
              <option value="optimista">Optimista</option>
              <option value="adverso">Adverso</option>
              <option value="custom">Personalizado</option>
            </select>
          </label>

          <label class="field">
            <div class="field__label">Crecimiento FP nacional (pp)</div>
            <input id="globalFpGrowth" type="range" min="-10" max="35" step="0.5" value="0"/>
            <div class="field__hint"><span id="globalFpGrowthVal">+0.0 pp</span></div>
          </label>

          <div class="hr"></div>

          <div class="panel__title">Alianzas</div>

          <label class="field">
            <div class="field__label">Tipo de alianza</div>
            <select id="allianceType">
              <option value="none">Sin alianza</option>
              <option value="transfer">Transferencia a FP</option>
            </select>
          </label>

          <label class="field">
            <div class="field__label">% transferencia a la boleta aliada (nacional)</div>
            <input id="allianceTransfer" type="range" min="0" max="100" step="1" value="85"/>
            <div class="field__hint"><span id="allianceTransferVal">85%</span></div>
          </label>

          <div class="hint" id="aliHint"></div>

          <div class="hr"></div>

          <details class="uiFold" open>
            <summary>Encuestas</summary>
            <div class="fieldRow">
              <button class="btn" id="btnAplicarEncuestaSimple" type="button">Aplicar encuesta</button>
              <button class="btn secondary" id="btnCompararEncuestas" type="button">Comparar</button>
            </div>

            <div class="fieldRow">
              <button class="btn secondary" id="btnAplicarMasReciente" type="button">Aplicar más reciente</button>
              <button class="btn secondary" id="btnGuardarEncuestaEquipo" type="button">Guardar en equipo</button>
            </div>

            <div class="panel__box">
              <div class="panel__boxTitle">Tendencia (Equipo)</div>
              <canvas id="pollTrend" height="120"></canvas>
              <table class="mini" id="tblPollHistory"></table>
            </div>
          </details>

          <details class="uiFold">
            <summary>Objetivo de votos</summary>
            <label class="field">
              <div class="field__label">Meta FP % (ej: 50.1)</div>
              <input id="targetPct" type="number" step="0.1" value="50.1"/>
            </label>
            <button class="btn" id="btnSolveTarget" type="button">Calcular</button>
            <div class="hint" id="targetResult"></div>
          </details>

          <details class="uiFold">
            <summary>Exportar / Cargar</summary>
            <div class="fieldRow">
              <button class="btn" id="btnExport" type="button">Exportar datos (CSV)</button>
              <button class="btn secondary" id="btnExportRanking" type="button">Exportar ranking</button>
            </div>
            <div class="fieldRow">
              <button class="btn secondary" id="btnCopyLink" type="button">Copiar link</button>
              <button class="btn" id="btnPrintReport" type="button">PDF</button>
              <button class="btn" id="btnMapPng" type="button">PNG mapa</button>
            </div>
            <div class="fieldRow">
              <button class="btn secondary" id="btnLoadPoll" type="button">Cargar encuesta</button>
              <button class="btn secondary" id="btnSavePoll" type="button">Guardar encuesta</button>
            </div>
          </details>

          <div class="fieldRow">
            <button class="btn ghost" id="btnResetSwing" type="button">Reset swings</button>
            <button class="btn ghost" id="btnHome" type="button">Inicio</button>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="content" id="view-dashboard">
        <section class="dashGrid">
          <div class="card" id="cardLevel">
            <div class="card__k">Nivel</div>
            <div class="card__v">—</div>
            <div class="card__s" id="cardLevelMeta">—</div>
          </div>
          <div class="card" id="cardWinner">
            <div class="card__k">Ganador</div>
            <div class="card__v">—</div>
            <div class="card__s" id="cardWinnerMeta">—</div>
          </div>
          <div class="card" id="cardSource">
            <div class="card__k">Fuente</div>
            <div class="card__v">Base 2024</div>
            <div class="card__s" id="cardSourceMeta">—</div>
          </div>
          <div class="card" id="cardAlliance">
            <div class="card__k">Alianza</div>
            <div class="card__v">Sin alianza</div>
            <div class="card__s" id="cardTransfer">Transfer: 85%</div>
          </div>
          <div class="card" id="cardArrLeg">
            <div class="card__k">Arrastre leg.</div>
            <div class="card__v">—</div>
            <div class="card__s">Prov. más débiles</div>
          </div>
          <div class="card" id="cardArrMun">
            <div class="card__k">Arrastre mun.</div>
            <div class="card__v">—</div>
            <div class="card__s">Mun. más débiles</div>
          </div>
        </section>

        <section class="panel">
          <div class="panel__title">Mapa nacional</div>
          <div class="mapWrap">
            <div id="mapHost" class="mapHost"></div>
          </div>
          <div class="legend">
            <span class="pill fp">FP</span>
            <span class="pill prm">PRM</span>
            <span class="pill pld">PLD</span>
            <span class="pill otros">OTROS</span>
            <span class="pill ali">ALIANZA</span>
          </div>
        </section>

        <section class="panel">
          <div class="panel__title">Resultados y ranking</div>
          <div class="twoCol">
            <div class="panel__box">
              <div class="panel__boxTitle">Nacional</div>
              <table class="mini" id="tblNational"></table>
              <div class="hint" id="cmpBox"></div>
              <div class="fieldRow">
                <button class="btn secondary" id="btnCompareAlliance" type="button">Comparar sin/con alianza</button>
              </div>
            </div>
            <div class="panel__box">
              <div class="panel__boxTitle">Ranking estratégico</div>
              <table class="mini" id="tblRanking"></table>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panel__title">Tablas por nivel</div>
          <div class="threeCol">
            <div class="panel__box">
              <div class="panel__boxTitle">Presidencial por provincia</div>
              <table class="mini" id="tblPresProv"></table>
            </div>
            <div class="panel__box">
              <div class="panel__boxTitle">Senadores por provincia</div>
              <table class="mini" id="tblSenProv"></table>
            </div>
            <div class="panel__box">
              <div class="panel__boxTitle">Diputados por circ.</div>
              <table class="mini" id="tblDipCirc"></table>
            </div>
          </div>

          <div class="twoCol" style="margin-top:14px">
            <div class="panel__box">
              <div class="panel__boxTitle">Arrastre provincia</div>
              <table class="mini" id="tblArrProv"></table>
            </div>
            <div class="panel__box">
              <div class="panel__boxTitle">Arrastre municipio</div>
              <table class="mini" id="tblArrMun"></table>
            </div>
          </div>

          <div class="twoCol" style="margin-top:14px">
            <div class="panel__box">
              <div class="panel__boxTitle">Alcaldías (top)</div>
              <table class="mini" id="tblAlcMun"></table>
            </div>
            <div class="panel__box">
              <div class="panel__boxTitle">Exterior (por país)</div>
              <table class="mini" id="tblExteriorPais"></table>
            </div>
          </div>

          <div class="panel__box" style="margin-top:14px">
            <div class="panel__boxTitle">Exterior (por circunscripción)</div>
            <table class="mini" id="tblExteriorCirc"></table>
          </div>
        </section>
      
      <section class="content" id="view-presidencial" style="display:none"></section>

      <section class="content" id="view-senadores" style="display:none"></section>

      <section class="content" id="view-diputados" style="display:none"></section>

      <section class="content" id="view-alcaldes" style="display:none"></section>

</section>
    </div>
  </main>

  <script src="app.js?v=222" defer></script>

  <script>
    // IE tabs only control visuals (B.1/B.2/B.3). Logic stays in JS.
    (function(){
      const tabs = document.querySelectorAll(".ieTab");
      const set = (key)=>{
        tabs.forEach(t=>t.classList.toggle("isActive", t.dataset.ie===key));
        document.body.dataset.ie = key;
      };
      tabs.forEach(t=>t.addEventListener("click", ()=>set(t.dataset.ie)));
      set("b1");
    })();

    // Mobile sidebar drawer
    (function(){
      const btn = document.getElementById("btnMobileMenu");
      const sidebar = document.getElementById("sidebar");
      if(!btn || !sidebar) return;
      btn.addEventListener("click", ()=>{
        document.body.classList.toggle("sidebarOpen");
      });
      document.addEventListener("click", (e)=>{
        if(!document.body.classList.contains("sidebarOpen")) return;
        const inside = sidebar.contains(e.target) || btn.contains(e.target);
        if(!inside) document.body.classList.remove("sidebarOpen");
      });
    })();
  </script>

<script>
(function(){
  // Failsafe: nunca dejar la pantalla pegada en "Cargando datos…"
  function forceHideLoader(msg){
    try{
      document.body.classList.add("loaded");
      var el = document.getElementById("dataAlerts");
      if(el){
        el.style.display = "block";
        el.textContent = msg || "El simulador cargó parcialmente, pero algo falló al iniciar. Revisa que /data/base_data.json y /assets existan y vuelve a intentar.";
      }
    }catch(e){}
  }

  // Si en 6s no arrancó, quitar loader y mostrar diagnóstico.
  var t = setTimeout(function(){
    forceHideLoader("No terminó de iniciar (timeout). En GitHub Pages abre estos links: /app.js y /data/base_data.json. Si abren bien, el problema es un error interno de arranque y debe reportarse.");
  }, 6000);

  // Si hay error JS, quitar loader y mostrarlo.
  window.addEventListener("error", function(e){
    forceHideLoader("Error de inicio: " + (e && e.message ? e.message : "desconocido") + ". (Safari a veces bloquea cosas).");
  });
  window.addEventListener("unhandledrejection", function(e){
    forceHideLoader("Error de inicio: promesa rechazada. " + (e && e.reason ? (e.reason.message || e.reason) : ""));
  });

  window.__clear_boot_watchdog = function(){ try{ clearTimeout(t); }catch(e){} };
})();
</script>

<div id="compatLayer" style="display:none">
<input id="level" value="dashboard"/>
<input id="selectedProvCode" value=""/>
<input id="selectedProvName" value=""/>
<input id="pivotThreshold" type="number" value="50"/>
<input id="targetFpPct" type="number" value="50"/>
<input id="pollingEnabled" type="checkbox"/>
<select id="rankMode"><option value="victoria">victoria</option></select>
<input id="scenarioName" value=""/>
<select id="seatsMode"><option value="2024">2024</option><option value="170">170</option><option value="manual">manual</option></select>
<div id="seatsHint"></div>
<input id="fpSwing" type="range" min="-20" max="40" step="0.5" value="0"/><span id="fpSwingVal">0</span>
<select id="pollStoreSelect"></select><div id="pollStoreHint"></div>
<input id="pollPartido"/><input id="pollCandidato"/><input id="pollEncuestadora"/><input id="pollFecha"/><input id="pollMOE" type="number" value="0"/><input id="pollFP" type="number" value="0"/><input id="pollPRM" type="number" value="0"/><input id="pollPLD" type="number" value="0"/><input id="pollOTROS" type="number" value="0"/>
<input id="pollWeightCand" type="range" min="0" max="100" value="50"/><div id="pollWeightCandLabel"></div><div id="pollWeightPartyLabel"></div>
<div id="cmpBox"><div id="cmpPres"></div><div id="cmpDip"></div><div id="cmpAlc"></div><div id="cmpDetails"></div></div>
<div id="mcHint"></div><div id="mcP1"></div><div id="mcP2"></div><div id="mcPw"></div>
<div id="aliPresImpact"></div><div id="aliDipImpact"></div><div id="aliAlcImpact"></div>
<table id="tblExtCirc"></table>
<input id="fileImportScenario" type="file" />
<button id="btnSaveScenario" type="button"></button><button id="btnLoadScenario" type="button"></button><button id="btnDeleteScenario" type="button"></button><button id="btnDeletePoll" type="button"></button><button id="btnEditSeats" type="button"></button>
<button id="toggleClassifier" type="button"></button>
</div>
</body>
</html>
